<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Peer</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <h2>Peer WebRTC</h2>

    <input type="text" id="message" placeholder="Send a message">
    <button onclick="sendMessage()">Send</button>
    <div id="messages"></div>
    <div id="share-link"></div>

    <script>
        let peer = null;
        let conn = null;
        let playerId = null;

        function sendMessage() {
            const message = document.getElementById('message').value;
            conn.send(message);
            displayMessage('Sent: ' + message);
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `<p>${message}</p>`;
        }

        function getUid() {
            return Math.random().toString(36).substring(2, 15);
        }

        function getPageUid() {
            return (window.location.search.match(/uid=([^&]+)/) || [])[1];
        }

        function reciprocateConnection() {
            peer.on("connection", function(_conn) {
                _conn.on("data", function(data){
                    displayMessage("Received: " + data);
                });
                _conn.on("open", () => {
                    console.log("Connection fully established and data channel is open");
                    if (!conn) {
                        connectOpponent();
                    }
                });
                _conn.on("close", () => {
                    console.log("Connection closed");
                    if (conn) {
                        conn.close()
                    }
                });
            });
        }

        function getOpponentId(playerId) {
            const [ uid, playerNumber ] = [ playerId.slice(0, -1), playerId.slice(-1) ];
            return `${uid}${playerNumber === "1" ? "2" : "1"}`;
        }

        function connectOpponent(callback) {
            const opponentId = getOpponentId(playerId);
            conn = peer.connect(opponentId);
            conn.on("open", () => {
                console.log(`Connection to ${opponentId} established!`);
                if (callback) {
                    callback();
                }
            });
        }

        function connect() {
            peer = new Peer(playerId);
            peer.on("open", id => console.log("My peer ID is: " + id));
            reciprocateConnection();

            let connected = false;
            const timer = setInterval(() => {
                if (connected) {
                    clearInterval(timer);
                    return;
                }
                connectOpponent(() => connected = true);
            }, 3000);
        }

        function setShareLink(uid) {
            const shareLink = document.getElementById("share-link");
            shareLink.innerHTML = `<a href="?uid=${uid}">Share this link with your friend</a>`;
        }

        function init() {
            playerId = getPageUid();
            connect(playerId);

            // const uid = getUid();
            // setShareLink(`${uid}2`);
            // connect(`${uid}1`);
        }
        init();
    </script>
</body>
</html>